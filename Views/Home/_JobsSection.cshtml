@model SWP391_Project.ViewModels.Home.HomePageVM

<div class="top-jobs-section">
    <div class="top-jobs-header">
        <div class="top-jobs-header-content">
            <div>
                <h2 class="top-jobs-title">Các việc làm tốt nhất</h2>
                <p class="top-jobs-subtitle">Gợi ý việc làm chất lượng phù hợp với bạn trên EZJob</p>
            </div>
            <a class="top-jobs-link" href="javascript:void(0)" onclick="showComingSoon(); return false;">
                <span>Xem tất cả</span>
                <i class="fas fa-arrow-right"></i>
            </a>
        </div>
    </div>

    <div class="top-jobs-body">
        <!-- Active Filters (inside Jobs section) -->
        @if (!string.IsNullOrEmpty(Model.SelectedLocation) && Model.SelectedLocation != "Ngẫu nhiên" ||
             !string.IsNullOrEmpty(Model.SelectedSalaryRange) ||
             !string.IsNullOrEmpty(Model.SelectedExperience) ||
             Model.SelectedDomainId.HasValue)
        {
            <div class="active-filters">
                <span class="active-filters-label">Bộ lọc đang áp dụng:</span>

                @if (!string.IsNullOrEmpty(Model.SelectedLocation) && Model.SelectedLocation != "Ngẫu nhiên")
                {
                    <div class="filter-badge">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>@Model.SelectedLocation</span>
                        <button class="filter-badge-remove" onclick="removeFilter('location')" title="Xóa bộ lọc">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                }

                @if (!string.IsNullOrEmpty(Model.SelectedSalaryRange))
                {
                    var salaryLabel = Model.SalaryRangeOptions.FirstOrDefault(s => s.Label == Model.SelectedSalaryRange)?.Label;
                    var displayLabel = salaryLabel?.Contains("triệu") == true ? salaryLabel : salaryLabel + " triệu";
                    <div class="filter-badge">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>@displayLabel</span>
                        <button class="filter-badge-remove" onclick="removeFilter('salary')" title="Xóa bộ lọc">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                }

                @if (!string.IsNullOrEmpty(Model.SelectedExperience))
                {
                    <div class="filter-badge">
                        <i class="fas fa-briefcase"></i>
                        <span>@Model.SelectedExperience</span>
                        <button class="filter-badge-remove" onclick="removeFilter('experience')" title="Xóa bộ lọc">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                }

                @if (Model.SelectedDomainId.HasValue)
                {
                    var domain = Model.TopDomains.FirstOrDefault(d => d.Id == Model.SelectedDomainId.Value);
                    if (domain != null)
                    {
                        <div class="filter-badge">
                            <i class="fas fa-industry"></i>
                            <span>@domain.Name</span>
                            <button class="filter-badge-remove" onclick="removeFilter('domain')" title="Xóa bộ lọc">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    }
                }
            </div>
        }

        <div class="row">
            <!-- Filter Sidebar -->
            <div class="col-lg-3">
                <div class="filter-sidebar">
                    <div class="filter-title">Lọc theo</div>

                    <!-- Location Filter -->
                    <div class="filter-group">
                        <div class="filter-group-label" onclick="toggleFilter('location')">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>Địa điểm</span>
                            <i class="fas fa-chevron-down ms-auto" id="location-chevron"></i>
                        </div>
                        <div class="filter-options" id="location-options">
                            @foreach (var loc in Model.LocationOptions)
                            {
                                <div class="filter-option @(Model.SelectedLocation == loc ? "active" : "")"
                                     onclick="applyFilter('location', '@loc')">
                                    @loc
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Salary Filter -->
                    <div class="filter-group">
                        <div class="filter-group-label" onclick="toggleFilter('salary')">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>Mức lương</span>
                            <i class="fas fa-chevron-down ms-auto" id="salary-chevron"></i>
                        </div>
                        <div class="filter-options filter-options-scrollable" id="salary-options">
                            @foreach (var salary in Model.SalaryRangeOptions)
                            {
                                var label = salary.Label.Contains("triệu") ? salary.Label : salary.Label + " triệu";
                                <div class="filter-option @(Model.SelectedSalaryRange == salary.Label ? "active" : "")"
                                     onclick="applyFilter('salary', '@salary.Label')">
                                    @label
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Experience Filter -->
                    <div class="filter-group">
                        <div class="filter-group-label" onclick="toggleFilter('experience')">
                            <i class="fas fa-briefcase"></i>
                            <span>Kinh nghiệm</span>
                            <i class="fas fa-chevron-down ms-auto" id="experience-chevron"></i>
                        </div>
                        <div class="filter-options" id="experience-options">
                            @foreach (var exp in Model.ExperienceOptions)
                            {
                                <div class="filter-option @(Model.SelectedExperience == exp.Label ? "active" : "")"
                                     onclick="applyFilter('experience', '@exp.Label')">
                                    @exp.Label
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Domain Filter -->
                    <div class="filter-group">
                        <div class="filter-group-label" onclick="toggleFilter('domain')">
                            <i class="fas fa-industry"></i>
                            <span>Ngành nghề</span>
                            <i class="fas fa-chevron-down ms-auto" id="domain-chevron"></i>
                        </div>
                        <div class="filter-options" id="domain-options">
                            @foreach (var domainOpt in Model.TopDomains)
                            {
                                <div class="filter-option @(Model.SelectedDomainId == domainOpt.Id ? "active" : "")"
                                     onclick="applyFilter('domain', '@domainOpt.Id')">
                                    @domainOpt.Name
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Jobs Grid -->
            <div class="col-lg-9">
                <div class="d-flex justify-content-end mb-3">
                    <div class="d-flex align-items-center gap-2">
                        <label class="text-muted mb-0" for="sortSelect" style="font-size:0.95rem;">Sắp xếp:</label>
                        <select id="sortSelect" class="form-select form-select-sm" style="width: 220px;" onchange="applySort(this.value)">
                            @foreach (var opt in Model.SortOptions)
                            {
                                var isSelected = Model.SortOption == opt.Value || (string.IsNullOrEmpty(Model.SortOption) && opt.Value == "newest");
                                <option value="@opt.Value" selected="@(isSelected ? "selected" : null)">@opt.Label</option>
                            }
                        </select>
                    </div>
                </div>

                @if (Model.JobCards != null && Model.JobCards.Any())
                {
                    <div class="jobs-grid">
                        @foreach (var card in Model.JobCards)
                        {
                            var job = card.Job;
                            <div class="job-card-grid" onclick="handleJobClick(@job.Id)">
                                <img class="job-card-grid__logo" src="@card.CompanyImageUrl" alt="@job.Company?.Name" />
                                <div style="flex:1; min-width: 0;">
                                    <h3 class="job-card-grid__title">@job.Title</h3>
                                    <div class="job-card-grid__company">@job.Company?.Name</div>

                                    <div class="job-card-grid__meta">
                                        @{
                                            string salaryText = "Thỏa thuận";
                                            if (job.LowerSalaryRange.HasValue && job.HigherSalaryRange.HasValue)
                                            {
                                                salaryText = $"{job.LowerSalaryRange.Value:N0} - {job.HigherSalaryRange.Value:N0} VNĐ";
                                            }
                                            else if (job.LowerSalaryRange.HasValue)
                                            {
                                                salaryText = $"Từ {job.LowerSalaryRange.Value:N0} VNĐ";
                                            }
                                            else if (job.HigherSalaryRange.HasValue)
                                            {
                                                salaryText = $"Đến {job.HigherSalaryRange.Value:N0} VNĐ";
                                            }
                                        }
                                        <span class="job-salary-chip">
                                            <i class="fa fa-money-bill-wave"></i>
                                            <span>@salaryText</span>
                                        </span>

                                        @if (job.RequiredSkills != null && job.RequiredSkills.Any())
                                        {
                                            var shownSkills = job.RequiredSkills.Take(2).ToList();
                                            var remaining = job.RequiredSkills.Count - shownSkills.Count;
                                            <div class="job-skills">
                                                @foreach (var skill in shownSkills)
                                                {
                                                    <span class="skill-badge">@skill.Name</span>
                                                }
                                                @if (remaining > 0)
                                                {
                                                    <span class="skill-badge">+@remaining</span>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <p class="text-muted mb-0">Hiện tại chưa có công việc nào.</p>
                    </div>
                }
            </div>
        </div>

        <!-- Pagination (bottom of section, centered horizontally) -->
        @if (Model.TotalPages > 1)
        {
            <div class="top-jobs-pagination">
                <div class="pagination">
                    <button class="pagination-btn @(Model.CurrentPage == 1 ? "disabled" : "")"
                            onclick="goToPage(@(Model.CurrentPage - 1))"
                            @(Model.CurrentPage == 1 ? "disabled" : "")>
                        <i class="fas fa-chevron-left"></i>
                    </button>

                    @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                    {
                        <button class="pagination-btn @(i == Model.CurrentPage ? "active" : "")"
                                onclick="goToPage(@i)">
                            @i
                        </button>
                    }

                    <button class="pagination-btn @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")"
                            onclick="goToPage(@(Model.CurrentPage + 1))"
                            @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="text-center mt-2">
                    <span class="text-muted">Trang @Model.CurrentPage / @Model.TotalPages</span>
                </div>
            </div>
        }
    </div>
</div>

