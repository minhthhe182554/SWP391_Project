@model SWP391_Project.ViewModels.Home.HomePageVM
@using SWP391_Project.Models
@using SWP391_Project.ViewModels.Home

@{
    ViewData["Title"] = "Tìm việc làm - EZJob";
    var currentDate = DateTime.Now.ToString("dd/MM/yyyy");
}

@section Styles {
    <link rel="stylesheet" href="~/css/home.css" asp-append-version="true" />
}


<!-- Hero Section -->
<div class="hero-section">
    <div class="container">
        <div class="hero-content">
            <h1 class="hero-title">EZJob - Tìm việc làm, Tuyển dụng hiệu quả</h1>
            <form method="get" asp-controller="Search" asp-action="Jobs" class="search-container">
                <input type="hidden" name="keywordType" value="job" />
                <input type="text" name="keyword" class="search-input" placeholder="Tìm việc theo chức danh, công ty, kỹ năng" />
                <button type="submit" class="search-btn">
                    <i class="fas fa-search"></i>
                    <span>Tìm kiếm</span>
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Thị trường việc làm hôm nay -->
<div class="market-stats">
    <div class="container">
        <div class="market-stats-content">
            <div class="market-stats-header">
                <i class="fas fa-briefcase" style="font-size: 1.5rem;"></i>
                <div>
                    <h3>Thị trường việc làm hôm nay</h3>
                    <div class="date">@currentDate</div>
                </div>
            </div>
            <div class="market-stats-items">
                <div class="market-stat-item">
                    <div class="label">Việc làm đang tuyển</div>
                    <div class="value">@Model.MarketActiveJobs.ToString("N0")</div>
                </div>
                <div class="market-stat-item">
                    <div class="label">Việc làm mới hôm nay</div>
                    <div class="value">@Model.MarketNewJobsToday.ToString("N0")</div>
                </div>
            </div>
        </div>
    </div>
</div>

@if (Model.RecommendedJobCards != null && Model.RecommendedJobCards.Any())
{
    <section class="recommended-wrap" id="recommended-jobs">
        <div class="container">
            <div class="top-jobs-section recommended-section">
                <div class="top-jobs-header recommended-hero">
                    <div class="top-jobs-header-content">
                        <div>
                            <h2 class="top-jobs-title">Việc làm phù hợp cho bạn</h2>
                            <p class="top-jobs-subtitle">Gợi ý dựa trên kỹ năng của bạn</p>
                        </div>
                    </div>
                </div>

                <div class="top-jobs-body">
                    <div class="jobs-grid">
                        @foreach (var card in Model.RecommendedJobCards)
                        {
                            var job = card.Job;
                            string salaryText = "Thỏa thuận";
                            if (job.LowerSalaryRange.HasValue && job.HigherSalaryRange.HasValue)
                            {
                                salaryText = $"{job.LowerSalaryRange.Value:N0} - {job.HigherSalaryRange.Value:N0} VNĐ";
                            }
                            else if (job.LowerSalaryRange.HasValue)
                            {
                                salaryText = $"Từ {job.LowerSalaryRange.Value:N0} VNĐ";
                            }
                            else if (job.HigherSalaryRange.HasValue)
                            {
                                salaryText = $"Đến {job.HigherSalaryRange.Value:N0} VNĐ";
                            }

                            <a class="job-card-grid text-decoration-none text-dark" asp-controller="Job" asp-action="Detail" asp-route-id="@job.Id">
                                <img class="job-card-grid__logo" src="@card.CompanyImageUrl" alt="@job.Company?.Name" />
                                <div style="flex:1; min-width: 0;">
                                    <h3 class="job-card-grid__title">@job.Title</h3>
                                    <div class="job-card-grid__company">@job.Company?.Name</div>

                                    <div class="job-card-grid__meta">
                                        <span class="job-salary-chip">
                                            <i class="fa fa-money-bill-wave"></i>
                                            <span>@salaryText</span>
                                        </span>

                                        <span class="job-location-chip">
                                            <i class="fa fa-map-marker-alt"></i>
                                            <span>@job.Location?.City @job.Location?.Ward</span>
                                        </span>

                                        <span class="job-exp-chip">
                                            <i class="fa fa-briefcase"></i>
                                            <span>@job.YearsOfExperience năm</span>
                                        </span>
                                    </div>

                                    @if (job.RequiredSkills != null && job.RequiredSkills.Any())
                                    {
                                        var shownSkills = job.RequiredSkills.Take(2).ToList();
                                        var remaining = job.RequiredSkills.Count - shownSkills.Count;
                                        <div class="job-skills">
                                            @foreach (var skill in shownSkills)
                                            {
                                                <span class="skill-badge">@skill.Name</span>
                                            }
                                            @if (remaining > 0)
                                            {
                                                <span class="skill-badge">+@remaining</span>
                                            }
                                        </div>
                                    }
                                </div>
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>
    </section>
}

<!-- Section Jobs -->
<section class="section-jobs" id="top-jobs">
    <div class="container">
        <div id="jobsSectionRoot">
            <partial name="_JobsSection" model="Model" />
        </div>
    </div>
</section>

<!-- Top Companies Section -->
<section class="container" id="top-companies">
    <div id="companiesSectionRoot">
        <partial name="_CompaniesSection" model="Model" />
    </div>
</section>

<!-- Login Modal -->
<div id="loginOverlay" class="login-overlay">
    <div class="login-modal">
        <h3 class="mb-3" style="color: #28a745; font-weight: bold;">Đăng nhập để xem chi tiết</h3>
        <p class="text-muted mb-4">Bạn cần đăng nhập để xem chi tiết công việc và ứng tuyển.</p>
        <div class="d-flex gap-2">
            <a asp-controller="Account" asp-action="Login" class="btn-primary-custom text-decoration-none text-center">
                Đăng nhập
            </a>
            <a asp-controller="Account" asp-action="Register" class="btn btn-outline-success" style="border-radius: 10px; padding: 0.75rem; flex: 1;">
                Đăng ký
            </a>
        </div>
        <button type="button" class="btn btn-link mt-3" onclick="closeLoginModal()" style="color: #6c757d; text-decoration: none;">
            Đóng
        </button>
    </div>
</div>

<script>
    function closeLoginModal() {
        document.getElementById('loginOverlay').style.display = 'none';
    }
    
    // Close modal when clicking outside
    document.getElementById('loginOverlay').addEventListener('click', function(e) {
        if (e.target === this) {
            closeLoginModal();
        }
    });
    
    function toggleFilter(filterType) {
        const options = document.getElementById(filterType + '-options');
        const chevron = document.getElementById(filterType + '-chevron');
        
        if (options.classList.contains('active')) {
            options.classList.remove('active');
            chevron.classList.remove('fa-chevron-up');
            chevron.classList.add('fa-chevron-down');
        } else {
            // Close all other filters
            document.querySelectorAll('.filter-options').forEach(opt => {
                if (opt !== options) {
                    opt.classList.remove('active');
                }
            });
            document.querySelectorAll('.filter-group-label i.fa-chevron-up').forEach(chev => {
                chev.classList.remove('fa-chevron-up');
                chev.classList.add('fa-chevron-down');
            });
            
            options.classList.add('active');
            chevron.classList.remove('fa-chevron-down');
            chevron.classList.add('fa-chevron-up');
        }
    }
    
    const jobsSectionEndpoint = '@Url.Action("JobsSection", "Home")';
    const companiesSectionEndpoint = '@Url.Action("CompaniesSection", "Home")';

    async function refreshJobsSection(nextUrl) {
        const container = document.getElementById('jobsSectionRoot');
        if (!container) {
            window.location.href = nextUrl.toString();
            return;
        }

        const partialUrl = new URL(jobsSectionEndpoint, window.location.origin);
        const keys = ['page', 'location', 'salaryRange', 'experience', 'domainId', 'sort'];
        keys.forEach(k => {
            const v = nextUrl.searchParams.get(k);
            if (v === null || v === '') {
                partialUrl.searchParams.delete(k);
            } else {
                partialUrl.searchParams.set(k, v);
            }
        });

        container.style.opacity = '0.6';
        try {
            const res = await fetch(partialUrl.toString(), {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (!res.ok) throw new Error('Failed to load jobs section');
            const html = await res.text();
            container.innerHTML = html;

            nextUrl.hash = 'top-jobs';
            history.replaceState(null, '', nextUrl.toString());
        } catch (e) {
            window.location.href = nextUrl.toString();
        } finally {
            container.style.opacity = '1';
        }
    }

    async function refreshCompaniesSection(nextUrl) {
        const container = document.getElementById('companiesSectionRoot');
        if (!container) {
            window.location.href = nextUrl.toString();
            return;
        }

        const partialUrl = new URL(companiesSectionEndpoint, window.location.origin);
        const keys = ['companyPage', 'companyDomainId'];
        keys.forEach(k => {
            const v = nextUrl.searchParams.get(k);
            if (v === null || v === '') {
                partialUrl.searchParams.delete(k);
            } else {
                partialUrl.searchParams.set(k, v);
            }
        });

        container.style.opacity = '0.6';
        try {
            const res = await fetch(partialUrl.toString(), {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (!res.ok) throw new Error('Failed to load companies section');
            const html = await res.text();
            container.innerHTML = html;

            nextUrl.hash = 'top-companies';
            history.replaceState(null, '', nextUrl.toString());
        } catch (e) {
            window.location.href = nextUrl.toString();
        } finally {
            container.style.opacity = '1';
        }
    }

    function applyFilter(filterType, value) {
        const url = new URL(window.location.href);
        url.searchParams.set('page', '1'); // Reset to page 1 when filter changes

        if (filterType === 'location') {
            if (value === 'Ngẫu nhiên') {
                url.searchParams.delete('location');
            } else {
                url.searchParams.set('location', value);
            }
        } else if (filterType === 'salary') {
            url.searchParams.set('salaryRange', value);
        } else if (filterType === 'experience') {
            url.searchParams.set('experience', value);
        } else if (filterType === 'domain') {
            url.searchParams.set('domainId', value);
        }

        refreshJobsSection(url);
    }

    function applySort(value) {
        const url = new URL(window.location.href);
        url.searchParams.set('page', '1');
        if (value === 'newest') {
            url.searchParams.delete('sort');
        } else {
            url.searchParams.set('sort', value);
        }
        refreshJobsSection(url);
    }

    function goToPage(page) {
        const url = new URL(window.location.href);
        url.searchParams.set('page', page.toString());
        refreshJobsSection(url);
    }

    function removeFilter(filterType) {
        const url = new URL(window.location.href);
        url.searchParams.set('page', '1'); // Reset to page 1

        if (filterType === 'location') {
            url.searchParams.delete('location');
        } else if (filterType === 'salary') {
            url.searchParams.delete('salaryRange');
        } else if (filterType === 'experience') {
            url.searchParams.delete('experience');
        } else if (filterType === 'domain') {
            url.searchParams.delete('domainId');
        }

        refreshJobsSection(url);
    }
    
    // Initialize: show active filter options
    document.addEventListener('DOMContentLoaded', function() {
        @if (!string.IsNullOrEmpty(Model.SelectedLocation) || !string.IsNullOrEmpty(Model.SelectedSalaryRange) || 
             !string.IsNullOrEmpty(Model.SelectedExperience) || Model.SelectedDomainId.HasValue)
        {
            <text>
            // Auto-expand filters that have selections
            @if (!string.IsNullOrEmpty(Model.SelectedLocation))
            {
                <text>toggleFilter('location');</text>
            }
            @if (!string.IsNullOrEmpty(Model.SelectedSalaryRange))
            {
                <text>toggleFilter('salary');</text>
            }
            @if (!string.IsNullOrEmpty(Model.SelectedExperience))
            {
                <text>toggleFilter('experience');</text>
            }
            @if (Model.SelectedDomainId.HasValue)
            {
                <text>toggleFilter('domain');</text>
            }
            </text>
        }
    });

    function scrollCompanyDomains(delta) {
        const el = document.getElementById('companyDomainScroller');
        if (!el) return;
        el.scrollLeft += delta;
    }

    function applyCompanyDomain(domainId) {
        const url = new URL(window.location.href);
        // giữ các filter job hiện tại, chỉ đổi filter company
        url.searchParams.set('companyPage', '1');
        if (domainId === null || domainId === undefined) {
            url.searchParams.delete('companyDomainId');
        } else {
            url.searchParams.set('companyDomainId', domainId.toString());
        }
        refreshCompaniesSection(url);
    }

    function goToCompanyPage(page) {
        const url = new URL(window.location.href);
        url.searchParams.set('companyPage', page.toString());
        refreshCompaniesSection(url);
    }

</script>
